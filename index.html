<script>
// Variables globales
let qcmData={title:'',totalQuestions:0,questions:[]};
let currentQuestionIndex=0;
let candidateAnswers=[];
let candidateName='';
let selectedAnswer=null;
let availableTests=[];
let selectedTestIndex=-1;
let startTime=null;
let timerInterval=null;
let totalTimeInSeconds=0;
const TESTS_DIRECTORY='./tests';

// Messages de statut
function showStatusMessage(message,type='info'){
 const container=document.getElementById('status-messages');
 const div=document.createElement('div');
 div.className=`status-message status-${type}`;div.textContent=message;
 container.appendChild(div);
 setTimeout(()=>{if(div.parentNode)div.parentNode.removeChild(div);},5000);
}

// === Gestion des tests ===
function fetchAvailableTests(){
 document.getElementById('loading-message').textContent='üîÑ Chargement des tests disponibles...';
 fetch('./tests/index.json')
   .then(r=>{if(!r.ok)throw new Error();return r.json();})
   .then(data=>{availableTests=data.tests||data;displayAvailableTests();})
   .catch(()=>{availableTests=[];displayAvailableTests();showStatusMessage('‚ö†Ô∏è Aucun test trouv√©','info');});
}

function displayAvailableTests(){
 const container=document.getElementById('available-tests');
 if(availableTests.length===0){
   container.innerHTML='<div class="no-tests-message">‚ùå Aucun test disponible</div>';return;
 }
 let html='';
 availableTests.forEach((t,i)=>{
   html+=`<div class="test-item" onclick="selectTest(${i})" id="test-item-${i}">
          <div class="test-info"><div><div class="test-title">${t.title}</div>
          ${t.description?`<div class="test-description">${t.description}</div>`:''}</div>
          <div class="test-questions">${t.totalQuestions} questions</div></div></div>`;
 });
 container.innerHTML=html;
}

function selectTest(i){
 if(selectedTestIndex!==-1)document.getElementById(`test-item-${selectedTestIndex}`).classList.remove('selected');
 selectedTestIndex=i;
 document.getElementById(`test-item-${i}`).classList.add('selected');
 document.getElementById('load-selected-test').disabled=false;
}

function loadSelectedTest(){
 if(selectedTestIndex===-1){showStatusMessage('‚ö†Ô∏è S√©lectionnez un test','error');return;}
 const t=availableTests[selectedTestIndex];
 fetch(`${TESTS_DIRECTORY}/${t.filename}`)
   .then(r=>r.json())
   .then(d=>{qcmData=d;showTestInfo();})
   .catch(()=>{showStatusMessage('‚ö†Ô∏è Test introuvable','error');});
}

function showTestInfo(){
 document.getElementById('load-section').classList.add('hidden');
 document.getElementById('qcm-info').classList.remove('hidden');
 document.getElementById('qcm-title-display').textContent=qcmData.title;
 document.getElementById('qcm-total-questions').textContent=qcmData.totalQuestions;
}

function returnToTestList(){
 document.getElementById('qcm-info').classList.add('hidden');
 document.getElementById('load-section').classList.remove('hidden');
}

// === D√©marrage et affichage du test ===
function startTest(){
 candidateName=document.getElementById('candidate-name').value.trim();
 if(!candidateName){showStatusMessage('‚ö†Ô∏è Entrez votre nom','error');return;}
 document.getElementById('qcm-info').classList.add('hidden');
 document.getElementById('test-section').classList.remove('hidden');
 candidateAnswers=[];currentQuestionIndex=0;
 document.getElementById('total-test-questions').textContent=qcmData.totalQuestions;
 startTime=new Date();clearInterval(timerInterval);
 timerInterval=setInterval(updateTimer,1000);
 displayTestQuestion();
}

function updateTimer(){
 totalTimeInSeconds=Math.floor((new Date()-startTime)/1000);
 document.getElementById('test-timer').textContent=`‚è±Ô∏è Temps: ${formatTime(totalTimeInSeconds)}`;
}

function formatTime(s){
 const m=Math.floor(s/60);return`${m.toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`;
}

function displayTestQuestion(){
 const q=qcmData.questions[currentQuestionIndex];
 document.getElementById('current-test-question').textContent=currentQuestionIndex+1;
 document.getElementById('test-question-text').textContent=q.text;
 document.getElementById('test-coefficient').textContent=q.coefficient;
 ['test-answer1','test-answer2','test-answer3'].forEach((id,i)=>document.getElementById(id).textContent=q.answers[i]);
 selectedAnswer=null;document.getElementById('next-button').disabled=true;
 document.querySelectorAll('.answer-option').forEach(o=>o.classList.remove('selected'));
 document.getElementById('progress').style.width=(currentQuestionIndex/qcmData.totalQuestions*100)+'%';
 document.getElementById('next-button').textContent=(currentQuestionIndex===qcmData.totalQuestions-1)?'üèÅ Terminer le test':'‚û°Ô∏è Question suivante';
}

function selectAnswer(n){
 selectedAnswer=n.toString();document.getElementById('next-button').disabled=false;
 document.querySelectorAll('.answer-option').forEach((o,i)=>o.classList.toggle('selected',i+1===n));
}

function saveAnswer(){
 if(selectedAnswer===null){showStatusMessage('‚ö†Ô∏è S√©lectionnez une r√©ponse','error');return;}
 candidateAnswers.push({questionIndex:currentQuestionIndex,questionText:qcmData.questions[currentQuestionIndex].text,answer:selectedAnswer,correctAnswer:qcmData.questions[currentQuestionIndex].correctAnswer,coefficient:qcmData.questions[currentQuestionIndex].coefficient});
 currentQuestionIndex++;
 if(currentQuestionIndex>=qcmData.totalQuestions)calculateAndDisplayResult();else displayTestQuestion();
}

// === R√©sultat et actions ===
function calculateAndDisplayResult(){
 clearInterval(timerInterval);
 let total=0,earn=0,correct=0;
 candidateAnswers.forEach(a=>{total+=parseInt(a.coefficient);if(a.answer===a.correctAnswer){earn+=parseInt(a.coefficient);correct++;}});
 const score=Math.round((earn/total)*20*100)/100;
 document.getElementById('question-display').classList.add('hidden');
 document.getElementById('progress').style.width='100%';
 const res=document.getElementById('test-result');res.classList.remove('hidden');
 res.innerHTML=`<h3>R√©sultat: ${score}/20</h3>
   <div class="action-buttons">
     <button onclick="downloadResults()">üíæ T√©l√©charger les r√©sultats</button>
     <button onclick="returnToTestListAfterResult()" class="secondary">‚Ü©Ô∏è Retour √† la liste des tests</button>
   </div>`;
 localStorage.setItem('lastTestResults',JSON.stringify({candidateName,testTitle:qcmData.title,score,answers:candidateAnswers}));
}

function downloadResults(){
 const r=JSON.parse(localStorage.getItem('lastTestResults')||'null');if(!r){showStatusMessage('‚ùå Aucun r√©sultat','error');return;}
 const blob=new Blob([JSON.stringify(r,null,2)],{type:'application/json'});const url=URL.createObjectURL(blob);
 const a=document.createElement('a');a.href=url;a.download=`result-${r.candidateName}.json`;document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);
 showStatusMessage('üíæ R√©sultats t√©l√©charg√©s','success');
}

// üîπ Nouveau : retour √† la liste depuis la page de r√©sultats
function returnToTestListAfterResult(){
 document.getElementById('test-section').classList.add('hidden');
 document.getElementById('test-result').classList.add('hidden');
 document.getElementById('load-section').classList.remove('hidden');
 candidateAnswers=[];candidateName='';currentQuestionIndex=0;
 selectedAnswer=null;selectedTestIndex=-1;totalTimeInSeconds=0;
 document.getElementById('candidate-name').value='';
 document.getElementById('progress').style.width='0%';
 refreshAvailableTests();
}

// Rafra√Æchir la liste
function refreshAvailableTests(){
 selectedTestIndex=-1;
 document.getElementById('load-selected-test').disabled=true;
 fetchAvailableTests();
}

window.onload=function(){showStatusMessage('üöÄ Application initialis√©e','success');fetchAvailableTests();}
</script>
